name: Version bump + release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Update version in ashita_manager.py
      shell: powershell
      run: |
        $path = 'ashita_manager.py'
        (Get-Content -Raw $path) -replace '(?<=__version__ = \")[^\"]*', '${{ github.event.inputs.version }}' | Set-Content $path

    - name: Build EXE with PyInstaller
      run: |
        python -m PyInstaller --onefile --windowed --name "Ashita Package Manager" --icon assets/logo.ico --add-data "assets:assets" ashita_manager.py

    - name: Commit and push version update
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add ashita_manager.py
        git commit -m "Bump version to ${{ github.event.inputs.version }}"
        git push origin HEAD:main
      continue-on-error: true

    - name: Create tag
      run: |
        git tag -a "${{ github.event.inputs.version }}" -m "Release ${{ github.event.inputs.version }}"
        git push origin "${{ github.event.inputs.version }}"
      continue-on-error: true

    - name: Generate changelog
      id: changelog
      shell: powershell
      run: |
        # Avoid terminating on non-zero native command exit codes
        $ErrorActionPreference = 'SilentlyContinue'

        # Try to get the previous tag; git returns non-zero when none exists
        $PREV_TAG = git describe --tags --abbrev=0 HEAD^ 2>$null

        if (-not $PREV_TAG -or $LASTEXITCODE -ne 0) {
          $CHANGELOG = 'Initial release'
        } else {
          $RANGE = "$PREV_TAG..HEAD"
          $CHANGELOG = git log --pretty=format:'- [`%h`](https://github.com/${{ github.repository }}/commit/%H) %s' $RANGE
        }

        # Always write output and return success
        echo "changelog=$CHANGELOG" >> $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version }}
        name: ${{ github.event.inputs.version }}
        body: ${{ steps.changelog.outputs.changelog }}
        files: dist/Ashita Package Manager.exe
